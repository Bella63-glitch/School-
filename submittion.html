<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Submission</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f8fafc; margin: 0; padding: 2rem; }
    .container { max-width: 600px; margin: auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
    h2 { text-align: center; color: #2b6cb0; }
    input, textarea { width: 100%; padding: 0.8rem; margin-top: 1rem; border: 1px solid #ccc; border-radius: 6px; }
    button { margin-top: 1.5rem; background: #2b6cb0; color: white; border: none; padding: 0.8rem 1.5rem; border-radius: 6px; cursor: pointer; }
    button:hover { background: #2c5282; }
    .hidden { display: none; }
    .school-item { margin-top: 1.5rem; padding: 1rem; background: #f1f5f9; border-radius: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h2 id="formTitle">Register</h2>

    <!-- Register Form -->
    <form id="registerForm">
      <input type="email" id="regEmail" placeholder="Email" required>
      <input type="password" id="regPassword" placeholder="Password" required>
      <button type="submit">Register</button>
    </form>

    <!-- Login Form -->
    <form id="loginForm" class="hidden">
      <input type="email" id="loginEmail" placeholder="Email" required>
      <input type="password" id="loginPassword" placeholder="Password" required>
      <button type="submit">Login</button>
    </form>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <h3>Submit a School</h3>
      <form id="submitForm">
        <input type="text" name="name" placeholder="School Name" required>
        <input type="text" name="location" placeholder="Location" required>
        <input type="text" name="curriculum" placeholder="Curriculum Type" required>
        <textarea name="description" placeholder="Description"></textarea>
        <input type="number" name="rating" placeholder="Rating (1-5)" min="1" max="5">
        <label>Upload Images (Max 10):</label>
        <input type="file" name="images" multiple accept="image/*" required>
        <button type="submit">Submit School</button>
      </form>

      <h3>Your Submitted Schools</h3>
      <div id="schoolList"></div>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    const APP_ID = "43FDF951-CA7C-4AA1-8CE5-EAEFE8AABBBB";
    const API_KEY = "D816E27F-267C-45B1-9932-AE452537BA0E";
    const BASE_URL = `https://api.backendless.com/${APP_ID}/${API_KEY}`;
    let currentUser = null;

    const regForm = document.getElementById("registerForm");
    const loginForm = document.getElementById("loginForm");
    const dashboard = document.getElementById("dashboard");
    const formTitle = document.getElementById("formTitle");

    if (localStorage.getItem("user-token")) {
      loginForm.classList.add("hidden");
      regForm.classList.add("hidden");
      dashboard.classList.remove("hidden");
      getCurrentUser().then(user => {
        currentUser = user;
        loadSchools();
      });
    }

    regForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      const email = document.getElementById("regEmail").value;
      const password = document.getElementById("regPassword").value;

      const res = await fetch(`${BASE_URL}/users/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, password }),
      });

      if (res.ok) {
        alert("Registered successfully. Please login.");
        regForm.reset();
        regForm.classList.add("hidden");
        loginForm.classList.remove("hidden");
        formTitle.innerText = "Login";
      } else {
        alert("Registration failed.");
      }
    });

    loginForm.addEventListener("submit", async function(e) {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value;
      const password = document.getElementById("loginPassword").value;

      const res = await fetch(`${BASE_URL}/users/login`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ login: email, password }),
      });

      if (res.ok) {
        const data = await res.json();
        localStorage.setItem("user-token", data["user-token"]);
        location.reload();
      } else {
        alert("Login failed.");
      }
    });

    async function getCurrentUser() {
      const token = localStorage.getItem("user-token");
      const res = await fetch(`${BASE_URL}/users/currentUser`, {
        headers: { "user-token": token },
      });
      return await res.json();
    }

    async function uploadImage(file) {
      const form = new FormData();
      form.append("file", file);
      const res = await fetch(`${BASE_URL}/files/school-uploads/${file.name}`, {
        method: "POST",
        body: form,
      });
      const data = await res.json();
      return data.fileURL || data.url;
    }

    document.getElementById("submitForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const form = e.target;
      const token = localStorage.getItem("user-token");

      const school = {
        name: form.name.value,
        location: form.location.value,
        curriculum: form.curriculum.value,
        description: form.description.value,
        rating: parseInt(form.rating.value),
      };

      const files = [...form.images.files];
      if (files.length > 10) return alert("Max 10 images allowed.");

      const images = await Promise.all(files.map(uploadImage));
      school.images = images;

      await fetch(`${BASE_URL}/data/schools`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "user-token": token },
        body: JSON.stringify(school),
      });

      alert("School submitted successfully.");
      form.reset();
      loadSchools();
    });

    async function loadSchools() {
      const token = localStorage.getItem("user-token");
      const res = await fetch(`${BASE_URL}/data/schools?where=ownerId='${currentUser.objectId}'`, {
        headers: { "user-token": token },
      });
      const schools = await res.json();
      const list = document.getElementById("schoolList");
      list.innerHTML = "";
      schools.forEach(school => {
        const div = document.createElement("div");
        div.className = "school-item";
        div.innerHTML = `
          <strong>${school.name}</strong><br>
          <small>${school.location}</small><br>
          <p>${school.curriculum}</p>
          <p>${school.description}</p>
          <p>Rating: ${school.rating}</p>
        `;
        list.appendChild(div);
      });
    }

    function logout() {
      localStorage.removeItem("user-token");
      location.reload();
    }
  </script>

</body></html>